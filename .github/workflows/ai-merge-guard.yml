name: AI Merge Guard

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-merge-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run AI Merge Agent
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/github/workspace \
            -w /github/workspace \
            -e GEMINI_API_KEY="$GEMINI_API_KEY" \
            tusharganotra/ai-merge-bot:v1

      - name: Post Gemini Report
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'comment.txt';
            if (fs.existsSync(path)) {
              const body = fs.readFileSync(path, 'utf8');
              github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body
              });
            }