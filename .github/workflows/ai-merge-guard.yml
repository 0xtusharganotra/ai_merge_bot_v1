name: AI Merge Guard

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-merge-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run AI Merge Bot (Docker Hub)
        id: run_agent
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/repo" \
            -e GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            -w /repo \
            --entrypoint "" \
            tusharganotra/ai-merge-bot:v2 \
            sh -c "git config --global --add safe.directory /repo && python /app/agent.py"
        continue-on-error: true

      - name: Check for comment file
        id: check_comment
        run: |
          if [ -f "comment.txt" ]; then
            echo "has_comment=true" >> $GITHUB_OUTPUT
            echo "Comment file found:"
            cat comment.txt
          else
            echo "has_comment=false" >> $GITHUB_OUTPUT
            echo "No comment.txt file found"
          fi

      - name: Post PR comment if needed
        if: steps.check_comment.outputs.has_comment == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'comment.txt';
            if (fs.existsSync(path)) {
              const body = fs.readFileSync(path, 'utf8');
              github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body
              });
            }
