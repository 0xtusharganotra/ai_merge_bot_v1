name: AI Merge Guard

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-merge-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run AI Merge Bot (Docker Hub)
        id: run_agent
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/repo" \
            -e GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            -w /repo \
            tusharganotra/ai-merge-bot:v2 || echo "exit_code=1" >> $GITHUB_ENV
        continue-on-error: true

      - name: Post PR comment if needed
        if: env.exit_code == '1' || hashFiles('comment.txt') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'comment.txt';
            if (fs.existsSync(path)) {
              const body = fs.readFileSync(path, 'utf8');
              github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body
              });
            }